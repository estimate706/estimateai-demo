generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  name       String?
  createdAt  DateTime  @default(now())
  projects   Project[]

  @@map("users")
}

model Region {
  id                  String                 @id @default(uuid())
  code                String                 @unique
  name                String
  materialMultiplier  Decimal                @default(1.0) @db.Decimal(10, 4)
  laborMultiplier     Decimal                @default(1.0) @db.Decimal(10, 4)
  zipMaps             RegionZipMap[]
  laborRates          LaborRate[]
  materialPrices      MaterialRegionPrice[]
  projects            Project[]
  estimates           Estimate[]

  @@map("regions")
}

model RegionZipMap {
  id       String @id @default(uuid())
  regionId String
  zipCode  String
  region   Region @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@index([zipCode])
  @@map("region_zip_maps")
}

model Material {
  id           String                 @id @default(uuid())
  sku          String?
  name         String
  description  String?
  unit         String
  baseCost     Decimal                @default(0) @db.Decimal(10, 2)
  category     String
  assemblies   AssemblyMaterial[]
  regionPrices MaterialRegionPrice[]

  @@map("materials")
}

model MaterialRegionPrice {
  id          String   @id @default(uuid())
  materialId  String
  regionId    String
  costPerUnit Decimal  @db.Decimal(10, 2)
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  region      Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@unique([materialId, regionId])
  @@map("material_region_prices")
}

model LaborRate {
  id          String  @id @default(uuid())
  regionId    String
  tradeCode   String
  description String?
  ratePerHour Decimal @db.Decimal(10, 2)
  region      Region  @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@unique([regionId, tradeCode])
  @@map("labor_rates")
}

model Assembly {
  id          String             @id @default(uuid())
  code        String             @unique
  name        String
  description String?
  category    String
  unit        String
  specJson    Json?
  materials   AssemblyMaterial[]
  labor       AssemblyLabor[]
  options     DropdownOption[]

  @@map("assemblies")
}

model AssemblyMaterial {
  id           String   @id @default(uuid())
  assemblyId   String
  materialId   String
  qtyPerUnit   Decimal  @db.Decimal(10, 4)
  wasteFactor  Decimal  @default(0) @db.Decimal(10, 4)
  assembly     Assembly @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  material     Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@map("assembly_materials")
}

model AssemblyLabor {
  id           String   @id @default(uuid())
  assemblyId   String
  tradeCode    String
  hoursPerUnit Decimal  @db.Decimal(10, 4)
  assembly     Assembly @relation(fields: [assemblyId], references: [id], onDelete: Cascade)

  @@map("assembly_labor")
}

model DropdownOption {
  id         String          @id @default(uuid())
  category   String
  code       String
  label      String
  assemblyId String?
  sortOrder  Int             @default(0)
  assembly   Assembly?       @relation(fields: [assemblyId], references: [id])
  selections UserSelection[]

  @@unique([category, code])
  @@map("dropdown_options")
}

model Project {
  id          String          @id @default(uuid())
  userId      String
  name        String
  zipCode     String?
  regionId    String?
  pdfBlobUrl  String?
  status      String          @default("draft")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  region      Region?         @relation(fields: [regionId], references: [id])
  files       ProjectFile[]
  measurements AIMeasurement[]
  selections  UserSelection[]
  estimates   Estimate[]

  @@index([userId])
  @@map("projects")
}

model ProjectFile {
  id           String   @id @default(uuid())
  projectId    String
  pageNumber   Int
  imageBlobUrl String
  widthPx      Int?
  heightPx     Int?
  dpi          Int?
  createdAt    DateTime @default(now())
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, pageNumber])
  @@map("project_files")
}

model AIMeasurement {
  id          String   @id @default(uuid())
  projectId   String
  pageNumber  Int?
  featureType String
  valueNum    Decimal? @db.Decimal(12, 2)
  valueText   String?
  confidence  String?
  metadata    Json?
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ai_measurements")
}

model UserSelection {
  id         String          @id @default(uuid())
  projectId  String
  category   String
  optionCode String
  valueText  String?
  createdAt  DateTime        @default(now())
  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  option     DropdownOption? @relation(fields: [optionCode, category], references: [code, category])

  @@unique([projectId, category])
  @@map("user_selections")
}

model Estimate {
  id               String   @id @default(uuid())
  projectId        String
  regionId         String?
  subtotalMaterial Decimal  @default(0) @db.Decimal(12, 2)
  subtotalLabor    Decimal  @default(0) @db.Decimal(12, 2)
  overheadPct      Decimal  @default(10) @db.Decimal(5, 2)
  profitPct        Decimal  @default(10) @db.Decimal(5, 2)
  totalAmount      Decimal  @default(0) @db.Decimal(12, 2)
  breakdownJson    Json?
  createdAt        DateTime @default(now())
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  region           Region?  @relation(fields: [regionId], references: [id])

  @@map("estimates")
}
